<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>reducer.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="action._makeAction.Action.html">Action</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action._makeAction.Action.html#.Action.clone">Action.clone</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action._makeAction.Action.html#.Action.empty">Action.empty</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action._makeAction.Action.html#.Action.getEntityId">Action.getEntityId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action._makeAction.Action.html#.Action.getEntityName">Action.getEntityName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action._makeAction.Action.html#.Action.getSchema">Action.getSchema</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action._makeAction.Action.html#.Action.withName">Action.withName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action._makeAction.Action.html#.Action.withPrefix">Action.withPrefix</a></span></li><li class="nav-heading">Namespaces</li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="action.html">action</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action.html#._makeAction">_makeAction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action.html#._makeActionHandler">_makeActionHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action.html#._makeActionUniqId">_makeActionUniqId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action.html#.exports.createAction">exports.createAction</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="config.html">config</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="config.html#.exports.setDefaultResponseMapper">exports.setDefaultResponseMapper</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="helper.html">helper</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="helper.html#._defaultResponseMapper">_defaultResponseMapper</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="reducer.html">reducer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="reducer.html#.exports.createReducers">exports.createReducers</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="selector.html">selector</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">reducer.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @namespace reducer
 */

import { fromJS } from 'immutable'
import { normalize } from 'normalizr'

import {
  ACTION_EMPTY_TYPE_NAME,
  ACTION_TYPE_PREFIX,
  ACTIONS_REDUCER_NAME,
  ENTITIES_REDUCER_NAME
} from './config'

const defaultEmptyActionData = {
  array: [],
  notArray: ''
}

const actionDefaultData = {
  isFetching: false,
  hasError: false,
  errorText: '',
  status: '',
  time: ''
}

const makeActionsReducer = defaultActionsState => {
  return (state = defaultActionsState, action) => {
    if (!action.prefix || action.prefix !== ACTION_TYPE_PREFIX) {
      return state
    }

    const {
      status,
      time,
      actionId,
      payload,
      sourceResult,
      isFetching,
      errorText,
      hasError,
      isArrayData,
      actionDataKey,
      actionSchema
    } = action

    const entityKey = actionSchema.key

    // action.clear
    if (action.type === ACTION_EMPTY_TYPE_NAME) {
      return state.set(
        actionId,
        fromJS(Object.assign({ entityKey }, actionDefaultData, { time }))
      )
    }

    const emptyData = actionDataKey
      ? defaultEmptyActionData[isArrayData ? 'array' : 'notArray']
      : undefined

    let actionState = state.get(actionId)

    // when action state is not defined need set new value
    if (!actionState) {
      state = state.set(actionId, fromJS(actionDefaultData))
      actionState = state.get(actionId)
    }

    actionState = actionState.merge({
      status,
      time,
      hasError,
      errorText,
      isFetching,
      isArrayData,
      actionDataKey
    })

    if (actionDataKey) {
      actionState = actionState.set(
        `prev${actionDataKey}`,
        actionState.get(actionDataKey, emptyData)
      )
    }

    if (sourceResult) {
      actionState = actionState.set('sourceResult', sourceResult)
    }

    if (!hasError &amp;&amp; actionDataKey &amp;&amp; payload) {
      actionState = actionState.set(actionDataKey, payload, {})
    }

    return state.set(actionId, actionState)
  }
}

const makeEntitiesReducer = defaultEntitiesState => {
  return function(state = defaultEntitiesState, action) {
    if (!action.prefix || action.prefix !== ACTION_TYPE_PREFIX) {
      return state
    }

    const {
      isFetching,
      hasError,
      isArrayData,
      payloadSource,
      actionSchema
    } = action

    const normalizedPayloadSource =
      payloadSource &amp;&amp; !hasError &amp;&amp; !isFetching
        ? normalize(isArrayData ? payloadSource : [payloadSource], [
            actionSchema
          ])
        : undefined

    const newEntitiesItems = normalizedPayloadSource
      ? normalizedPayloadSource.entities
      : {}

    // merge entity item data
    for (let entityName in newEntitiesItems) {
      for (let entityId in newEntitiesItems[entityName]) {
        let prevEntityState = state.getIn([entityName, entityId])
        let nextEntityState = fromJS(newEntitiesItems[entityName][entityId])

        if (!prevEntityState) {
          state = state.setIn([entityName, entityId], nextEntityState)
          continue
        }

        state = state.mergeIn([entityName, entityId], nextEntityState)
      }
    }

    // todo add isFetching attribute in entity item

    return state
  }
}
/**
 * This function returns object with actions reducer and entities reducer
 *
 * @memberOf reducer
 * @function
 *
 * @example
 * import { schema } from 'normalizr'
 * import { createReducers } from 'redux-tide'
 *
 * const userSchema = new schema.Entity('user', {})
 * const commentSchema = new schema.Entity('comment', { user:userSchema }, { idAttribute: 'comment_id' })
 *
 * const rootReducer = {
 *  ...createReducers(userSchema, commentSchema)
 * }
 * const store = createStore(
 *  combineReducers(rootReducer),
 *  initialState,
 *  compose(...enhancers)
 * )
 *
 * @param {Arguments} appSchema
 * @returns {Object} - {[ACTIONS_REDUCER_NAME]:Function, [ENTITIES_REDUCER_NAME]:Function}
 */
export const createReducers = (...appSchema) => {
  // default state for actions
  const defaultActionsState = fromJS({})

  // default state for entities
  const defaultEntitiesState = fromJS(
    appSchema.reduce((memo, item) => {
      memo[item.key] = {}
      return memo
    }, {})
  )
  return {
    [ACTIONS_REDUCER_NAME]: makeActionsReducer(defaultActionsState),
    [ENTITIES_REDUCER_NAME]: makeEntitiesReducer(defaultEntitiesState)
  }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Jan 12 2018 19:25:51 GMT+0300 (MSK) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
