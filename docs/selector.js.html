<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>selector.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="action.makeAction.this.actionId.html">this.actionId</a></span></li><li class="nav-heading">Namespaces</li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="action.html">action</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action.html#.exports.createAction">exports.createAction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action.html#.makeAction">makeAction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action.html#.makeActionHandler">makeActionHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="action.html#.makeActionUniqId">makeActionUniqId</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="config.html">config</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="config.html#.exports.setDefaultResponseMapper">exports.setDefaultResponseMapper</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="helper.html">helper</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="helper.html#._defaultResponseMapper">_defaultResponseMapper</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="reducer.html">reducer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="reducer.html#.exports.createReducers">exports.createReducers</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="selector.html">selector</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">selector.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @namespace selector
 */

import { createSelector } from 'reselect'
import { denormalize } from './helper'
import {
  ACTIONS_REDUCER_NAME,
  ENTITIES_REDUCER_NAME,
  IS_TEST_ENVIRONMENT
} from './config'

const defaultActionDataOutput = {
  status: '',
  time: '',
  hasError: '',
  errorText: '',
  isFetching: false
}

const deepCopy = obj => {
  return JSON.parse(JSON.stringify(obj))
}

const makeDefaultActionData = () => {
  return deepCopy(defaultActionDataOutput)
}

const getPayloadIds = (dataKey, isArray, actionState, stateKey) => {
  if (!dataKey) {
    return undefined
  }

  const payloadIds = actionState.get(stateKey || dataKey)

  if (!payloadIds) {
    return undefined
  }

  return isArray ? payloadIds : [payloadIds]
}

const makeActionDenormalizedPayload = (
  isArray,
  payloadIds,
  schema,
  entities
) => {
  if (!payloadIds) {
    return undefined
  }

  const result = denormalize(payloadIds, [schema], entities)
    .filter(v => v)
    .map(item => item.toJS())
  return isArray ? result : result[0]
}

const makeActionDenormalizedPayloads = (
  isFetching,
  actionSchema,
  entities,
  payloadIsArray,
  actionDataKey,
  entityState,
  actionState
) => {
  if (!actionDataKey) {
    return {}
  }

  if (!entityState) {
    return {
      payload: payloadIsArray ? [] : undefined,
      prevPayload: payloadIsArray ? [] : undefined
    }
  }

  const actionPayloadIds = getPayloadIds(
    actionDataKey,
    payloadIsArray,
    actionState
  )
  const actionPrevPayloadIds = getPayloadIds(
    actionDataKey,
    payloadIsArray,
    actionState,
    `prev${actionDataKey}`
  )

  return {
    payload: makeActionDenormalizedPayload(
      payloadIsArray,
      actionPayloadIds,
      actionSchema,
      entities
    ),
    prevPayload: makeActionDenormalizedPayload(
      payloadIsArray,
      actionPrevPayloadIds,
      actionSchema,
      entities
    )
  }
}

const _makeGetActionData = (action, actionId, entityName, actionSchema) => {
  return createSelector(
    [
      state => state[ACTIONS_REDUCER_NAME].get(actionId),
      state => state[ENTITIES_REDUCER_NAME].get(entityName),
      state => state[ENTITIES_REDUCER_NAME]
    ],
    (actionState, entityState, entities) => {
      if (!actionState) {
        return makeDefaultActionData()
      }

      const payloadIsArray = actionState.get('isArrayData')
      const dataKey = actionState.get('actionDataKey')
      const isFetching = actionState.get('status') === 'pending'

      return Object.assign(
        makeDefaultActionData(),
        {
          actionId,
          sourceResult: actionState.get('sourceResult'),
          status: actionState.get('status'),
          time: actionState.get('time'),
          hasError: actionState.get('hasError'),
          errorText: actionState.get('errorText'),
          isFetching: actionState.get('isFetching')
        },
        makeActionDenormalizedPayloads(
          isFetching,
          actionSchema,
          entities,
          payloadIsArray,
          dataKey,
          entityState,
          actionState
        )
      )
    }
  )
}

export const getActionData = action => {
  const actionId = action.actionId()
  const entityName = action.getEntityName()
  const actionEntitySchema = action.getSchema()

  return (state, props) => {
    const selectorGetActionData = _makeGetActionData(
      action,
      actionId,
      entityName,
      actionEntitySchema
    )
    return selectorGetActionData(state, props)
  }
}

export const getMergedActionsData = (...actions) => {
  return createSelector(
    actions.map(action => getActionData(action)),
    (...actionsData) => {
      const sortedByUpate = actionsData.sort((a, b) => a.time - b.time)

      return sortedByUpate.reduce((memo, item) => {
        return Object.assign(memo, item)
      })
    }
  )
}

export const getActionsReducer = state => state[ACTIONS_REDUCER_NAME]

export const getEntityReducer = state => state[ENTITIES_REDUCER_NAME]

export const getEntityItemsBySchema = entitySchema => {
  return createSelector([getEntityReducer], entities => {
    return entities.get(entitySchema.key)
  })
}

export const getEntityItemsByAction = action => {
  return createSelector([getEntityReducer], entities => {
    return entities.get(action.getEntityName())
  })
}

export const getEntityItemsByEntityName = name => {
  return createSelector([getEntityReducer], entities => {
    return entities.get(name)
  })
}

export const denomalizeEntityItemById = (id, schema, entities) => {
  return denormalize(id, schema, entities)
}

if (IS_TEST_ENVIRONMENT) {
  module.exports.defaultActionDataOutput = defaultActionDataOutput
  module.exports._makeGetActionData = _makeGetActionData
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Jan 17 2018 01:33:06 GMT+0300 (MSK) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
